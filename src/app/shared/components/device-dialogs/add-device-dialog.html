<gc-modal [isOpen]="isOpen" [title]="'Add New Gadget'" [maxWidth]="'lg'" (close)="onClose()">
  <!-- Error Message -->
  <div *ngIf="error" class="error-banner">
    <div class="error-content">
      <span class="error-icon">‚ö†Ô∏è</span>
      <div class="error-text">
        <strong>{{ error.includes('limit') ? 'Device Limit Exceeded' : 'Error' }}</strong>
        <p>{{ error }}</p>
      </div>
    </div>
    <div *ngIf="error.includes('upgrade')" class="error-actions">
      <button type="button" class="btn-upgrade" (click)="onUpgradePlan()">
        üöÄ Upgrade Plan
      </button>
    </div>
  </div>

  <!-- Step 0: Choose Creation Method -->
  <div *ngIf="currentStep === 0 && creationMode === 'manual'" class="method-choice">
    <h3>How would you like to add your gadget?</h3>

    <div class="method-options">
      <button type="button" class="method-card" (click)="onMethodSelect('photo')">
        <div class="method-icon">üì∏</div>
        <h4>Take a Photo</h4>
        <p>Snap a picture and let AI fill in the details</p>
        <span class="badge">Recommended</span>
      </button>

      <button type="button" class="method-card" (click)="onMethodSelect('manual')">
        <div class="method-icon">‚úèÔ∏è</div>
        <h4>Enter Manually</h4>
        <p>Fill in the information yourself</p>
      </button>
    </div>
  </div>

  <!-- Photo Capture/Analysis -->
  <div *ngIf="currentStep === 0 && creationMode === 'photo'" class="photo-capture">
    <div class="photo-input-zone">
      <input
        type="file"
        #photoInput
        accept="image/jpeg,image/png,image/jpg"
        capture="environment"
        (change)="onPhotoCapture($event)"
        hidden
      />

      <button
        type="button"
        class="photo-capture-btn"
        (click)="photoInput.click()"
        [disabled]="isAnalyzing"
      >
        <span class="camera-icon">üì∑</span>
        <span>{{ capturedPhoto ? 'Retake Photo' : 'Take Photo' }}</span>
      </button>

      <!-- Photo Preview -->
      <div *ngIf="photoPreviewUrl" class="photo-preview">
        <img [src]="photoPreviewUrl" alt="Captured device photo" />
      </div>

      <!-- Analysis Progress -->
      <div *ngIf="isAnalyzing" class="analysis-progress">
        <div class="spinner"></div>
        <p>Analyzing photo...</p>
        <p class="analysis-hint">Extracting device information using AI</p>
      </div>

      <!-- Analysis Error -->
      <div *ngIf="analysisError" class="analysis-error">
        <span class="error-icon">‚ö†Ô∏è</span>
        <p>{{ analysisError }}</p>
        <gc-button variant="secondary" size="sm" (onClick)="retakePhoto()">
          Try Again
        </gc-button>
        <gc-button variant="ghost" size="sm" (onClick)="switchToManual()">
          Enter Manually
        </gc-button>
      </div>
    </div>
  </div>

  <!-- Stepper (hidden on Step 0) -->
  <div *ngIf="currentStep > 0" class="stepper">
    <div
      *ngFor="let step of [1, 2, 3]"
      class="step"
      [class.active]="currentStep === step"
      [class.completed]="currentStep > step"
      (click)="goToStep(step)"
    >
      <div class="step-circle">
        <span *ngIf="currentStep <= step" class="step-number">{{ step }}</span>
        <span *ngIf="currentStep > step" class="step-check">‚úì</span>
      </div>
      <div class="step-label">
        <span *ngIf="step === 1">Basic Info</span>
        <span *ngIf="step === 2">Warranty</span>
        <span *ngIf="step === 3">Details</span>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form [formGroup]="deviceForm" class="device-form">
    <!-- Step 1: Basic Info -->
    <div *ngIf="currentStep === 1" class="form-step">
      <!-- Analysis Success Banner -->
      <div *ngIf="analysisResult && analysisResult.status === 'success'" class="analysis-banner success">
        <span class="banner-icon">‚úì</span>
        <div class="banner-content">
          <strong>Photo analyzed successfully!</strong>
          <p>We've pre-filled the information below. Please review and edit as needed.</p>
        </div>
      </div>

      <!-- Analysis Partial Banner -->
      <div *ngIf="analysisResult && analysisResult.status === 'partial'" class="analysis-banner warning">
        <span class="banner-icon">‚ö†Ô∏è</span>
        <div class="banner-content">
          <strong>Partial information extracted</strong>
          <p>Please review the pre-filled fields and complete any missing information.</p>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Gadget Name *</label>
        <input
          type="text"
          formControlName="name"
          class="form-input"
          [class.invalid]="isFieldInvalid('name')"
          placeholder="e.g., MacBook Pro 16&quot;"
        />
        <span *ngIf="isFieldInvalid('name')" class="error-text">
          Gadget name is required
        </span>
      </div>

      <div class="form-group">
        <label class="form-label">Category *</label>
        <select
          formControlName="category"
          class="form-input"
          [class.invalid]="isFieldInvalid('category')"
        >
          <option value="">Select category</option>
          <option *ngFor="let cat of categories" [value]="cat.value">
            {{ cat.label }} {{ cat.emoji }}
          </option>
        </select>
        <span *ngIf="isFieldInvalid('category')" class="error-text">
          Category is required
        </span>
        <div
          *ngIf="analysisResult?.extractedData?.suggestedCategory"
          class="field-hint ai-suggested"
        >
          <span class="hint-icon">ü§ñ</span>
          AI suggested category
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Manufacturer</label>
          <input
            type="text"
            formControlName="manufacturer"
            class="form-input"
            placeholder="e.g., Apple"
          />
          <div
            *ngIf="analysisResult?.extractedData?.brand"
            class="field-hint"
            [class.confidence-high]="analysisResult && analysisResult.extractedData.confidence.brand && hasHighConfidence(analysisResult.extractedData.confidence.brand)"
            [class.confidence-medium]="analysisResult && analysisResult.extractedData.confidence.brand && getConfidenceLabel(analysisResult.extractedData.confidence.brand) === 'medium'"
          >
            <span class="hint-icon">ü§ñ</span>
            AI extracted ({{ analysisResult && analysisResult.extractedData.confidence.brand ? getConfidenceLabel(analysisResult.extractedData.confidence.brand) : '' }} confidence)
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Model</label>
          <input
            type="text"
            formControlName="model"
            class="form-input"
            placeholder="e.g., M3 Max"
          />
          <div
            *ngIf="analysisResult?.extractedData?.model"
            class="field-hint"
            [class.confidence-high]="analysisResult && analysisResult.extractedData.confidence.model && hasHighConfidence(analysisResult.extractedData.confidence.model)"
            [class.confidence-medium]="analysisResult && analysisResult.extractedData.confidence.model && getConfidenceLabel(analysisResult.extractedData.confidence.model) === 'medium'"
          >
            <span class="hint-icon">ü§ñ</span>
            AI extracted ({{ analysisResult && analysisResult.extractedData.confidence.model ? getConfidenceLabel(analysisResult.extractedData.confidence.model) : '' }} confidence)
          </div>
        </div>
      </div>

      <!-- Show Raw Extracted Text (collapsible) -->
      <details *ngIf="analysisResult?.extractedData?.rawText" class="raw-text-details">
        <summary>View extracted text from photo</summary>
        <pre class="raw-text">{{ analysisResult?.extractedData?.rawText }}</pre>
      </details>
    </div>

    <!-- Step 2: Purchase & Warranty -->
    <div *ngIf="currentStep === 2" class="form-step">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Purchase Date</label>
          <input
            type="date"
            formControlName="purchaseDate"
            class="form-input"
            [class.invalid]="isFieldInvalid('purchaseDate')"
          />
          <span *ngIf="isFieldInvalid('purchaseDate')" class="error-text">
            Purchase date is required
          </span>
        </div>

        <div class="form-group">
          <label class="form-label">Purchase Price</label>
          <div class="input-group">
            <span class="input-prefix">$</span>
            <input
              type="number"
              formControlName="purchasePrice"
              class="form-input"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Warranty Expires</label>
          <input
            type="date"
            formControlName="warrantyExpires"
            class="form-input"
            [class.invalid]="isFieldInvalid('warrantyExpires')"
          />
          <span *ngIf="isFieldInvalid('warrantyExpires')" class="error-text">
            Warranty expiration is required
          </span>
        </div>

        <div class="form-group">
          <label class="form-label">Warranty Provider</label>
          <input
            type="text"
            formControlName="warrantyProvider"
            class="form-input"
            placeholder="e.g., AppleCare+"
          />
        </div>
      </div>
    </div>

    <!-- Step 3: Additional Details -->
    <div *ngIf="currentStep === 3" class="form-step">
      <div class="form-group">
        <label class="form-label">Serial Number</label>
        <input
          type="text"
          formControlName="serialNumber"
          class="form-input"
          placeholder="e.g., C02YX3ABMD6T"
        />
        <div
          *ngIf="analysisResult?.extractedData?.serialNumber"
          class="field-hint"
          [class.confidence-high]="analysisResult && analysisResult.extractedData.confidence.serialNumber && hasHighConfidence(analysisResult.extractedData.confidence.serialNumber)"
          [class.confidence-medium]="analysisResult && analysisResult.extractedData.confidence.serialNumber && getConfidenceLabel(analysisResult.extractedData.confidence.serialNumber) === 'medium'"
        >
          <span class="hint-icon">ü§ñ</span>
          AI extracted ({{ analysisResult && analysisResult.extractedData.confidence.serialNumber ? getConfidenceLabel(analysisResult.extractedData.confidence.serialNumber) : '' }} confidence)
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea
          formControlName="notes"
          class="form-input form-textarea"
          rows="4"
          placeholder="Add any additional notes about this device..."
        ></textarea>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <gc-button
        *ngIf="currentStep > 0"
        variant="secondary"
        (onClick)="previousStep()"
        [disabled]="isSubmitting"
      >
        Back
      </gc-button>

      <gc-button
        *ngIf="currentStep > 0"
        variant="primary"
        (onClick)="nextStep()"
        [disabled]="isSubmitting"
        class="next-button"
      >
        <span *ngIf="currentStep < totalSteps">Next Step</span>
        <span *ngIf="currentStep === totalSteps && !isSubmitting">Add Gadget</span>
        <span *ngIf="isSubmitting">Adding...</span>
      </gc-button>
    </div>
  </form>
</gc-modal>
