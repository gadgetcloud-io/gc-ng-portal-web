<!-- Modal Backdrop -->
<div
  class="modal-backdrop"
  *ngIf="isOpen"
  (click)="handleBackdropClick($event)"
  [@fadeIn]
>
  <!-- Modal Container -->
  <div class="modal-container" [@slideUp]>
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-header-content">
        <h2 class="modal-title">Choose Your Plan</h2>
        <p class="modal-subtitle">Select the plan that best fits your needs</p>
      </div>
      <button
        class="modal-close-button"
        (click)="handleClose()"
        type="button"
        aria-label="Close modal"
      >
        <span class="close-icon">‚úï</span>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Loading State -->
      <div *ngIf="isLoadingPlans" class="modal-loading">
        <gc-loading-spinner
          variant="primary"
          size="lg"
          label="Loading plans..."
          [centered]="true"
        ></gc-loading-spinner>
      </div>

      <!-- Error State -->
      <gc-alert
        *ngIf="loadError && !isLoadingPlans"
        variant="error"
        [dismissible]="false"
      >
        {{ loadError }}
      </gc-alert>

      <!-- Plans Grid -->
      <div
        *ngIf="!isLoadingPlans && !loadError && plans.length > 0"
        class="plans-grid"
      >
        <div
          *ngFor="let plan of plans; let i = index"
          class="plan-card-wrapper"
          [class.current-plan]="isCurrentPlan(plan.id)"
          [class.most-popular]="isMostPopular(i)"
        >
          <!-- Most Popular Badge -->
          <div *ngIf="isMostPopular(i)" class="popular-badge">
            <span class="popular-icon">‚≠ê</span>
            <span class="popular-text">Most Popular</span>
          </div>

          <gc-card
            [variant]="getPlanVariant(i)"
            padding="lg"
            [class.elevated]="isMostPopular(i)"
          >
            <!-- Plan Header -->
            <div class="plan-header">
              <div class="plan-header-top">
                <h3 class="plan-name">{{ plan.displayName }}</h3>
                <gc-badge
                  *ngIf="isCurrentPlan(plan.id)"
                  variant="success"
                  size="sm"
                >
                  Current Plan
                </gc-badge>
              </div>
              <p class="plan-description">{{ plan.description }}</p>
            </div>

            <!-- Plan Price -->
            <div class="plan-price-section">
              <div class="plan-price">
                <span class="price-currency">‚Çπ</span>
                <span class="price-amount">{{ plan.price.amount }}</span>
                <span class="price-period" *ngIf="plan.price.amount > 0">
                  /{{ getBillingPeriodLabel(plan.price.billingPeriod) }}
                </span>
                <span class="price-period" *ngIf="plan.price.amount === 0">
                  forever
                </span>
              </div>
            </div>

            <!-- Plan Features -->
            <div class="plan-features">
              <div
                *ngFor="let feature of getFeatureList(plan)"
                class="feature-item"
              >
                <span class="feature-icon">‚úì</span>
                <span class="feature-text">{{ feature }}</span>
              </div>
            </div>

            <!-- Plan Action -->
            <div class="plan-action">
              <button
                *ngIf="!isCurrentPlan(plan.id)"
                class="btn-select-plan"
                [class.btn-primary]="isMostPopular(i)"
                [class.btn-secondary]="!isMostPopular(i)"
                (click)="selectPlan(plan)"
                type="button"
              >
                <span *ngIf="plan.price.amount === 0">Get Started Free</span>
                <span *ngIf="plan.price.amount > 0 && plan.name === 'Premium'">Contact Sales</span>
                <span *ngIf="plan.price.amount > 0 && plan.name !== 'Premium'">Select Plan</span>
              </button>
              <button
                *ngIf="isCurrentPlan(plan.id)"
                class="btn-current-plan"
                disabled
                type="button"
              >
                Current Plan
              </button>
            </div>
          </gc-card>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Dialog - Request Form -->
  <div
    *ngIf="showConfirmation && selectedPlan && !requestSubmitted"
    class="confirmation-overlay"
    [@fadeIn]
  >
    <div class="confirmation-dialog confirmation-dialog--wide" [@scaleIn]>
      <div class="confirmation-header">
        <span class="confirmation-icon">üìã</span>
        <h3 class="confirmation-title">Request Plan Upgrade</h3>
      </div>

      <div class="confirmation-body">
        <p class="confirmation-text">
          You're requesting to upgrade to the
          <strong>{{ selectedPlan.displayName }}</strong> plan
          <span *ngIf="selectedPlan.price.amount > 0">
            (‚Çπ{{ selectedPlan.price.amount }}/{{ getBillingPeriodLabel(selectedPlan.price.billingPeriod) }})
          </span>
          <span *ngIf="selectedPlan.price.amount === 0">
            (Free forever)
          </span>.
        </p>

        <!-- Request Form Fields -->
        <div class="request-form">
          <div class="form-field">
            <label for="urgency" class="form-label">Urgency</label>
            <select
              id="urgency"
              class="form-select"
              [(ngModel)]="upgradeUrgency"
              [disabled]="isSubmittingRequest"
            >
              <option value="low">Low - Within a week</option>
              <option value="normal">Normal - Within a few days</option>
              <option value="high">High - As soon as possible</option>
            </select>
          </div>

          <div class="form-field">
            <label for="reason" class="form-label">
              Reason for upgrade
              <span class="form-label-optional">(optional)</span>
            </label>
            <textarea
              id="reason"
              class="form-textarea"
              [(ngModel)]="upgradeReason"
              placeholder="Tell us why you'd like to upgrade..."
              rows="3"
              maxlength="1000"
              [disabled]="isSubmittingRequest"
            ></textarea>
          </div>
        </div>

        <p class="confirmation-note">
          <span class="note-icon">‚ÑπÔ∏è</span>
          Our support team will review your request and contact you within 24-48 hours.
        </p>

        <!-- Error Alert -->
        <gc-alert
          *ngIf="requestError"
          variant="error"
          [dismissible]="false"
          class="request-error"
        >
          {{ requestError }}
        </gc-alert>
      </div>

      <div class="confirmation-actions">
        <button
          class="btn-confirm"
          (click)="confirmPlanSelection()"
          type="button"
          [disabled]="isSubmittingRequest"
        >
          <span *ngIf="!isSubmittingRequest">Submit Request</span>
          <span *ngIf="isSubmittingRequest" class="btn-loading">
            <span class="loading-spinner"></span>
            Submitting...
          </span>
        </button>
        <button
          class="btn-cancel"
          (click)="cancelPlanSelection()"
          type="button"
          [disabled]="isSubmittingRequest"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Success Dialog -->
  <div
    *ngIf="requestSubmitted && ticketId"
    class="confirmation-overlay"
    [@fadeIn]
  >
    <div class="confirmation-dialog" [@scaleIn]>
      <div class="confirmation-header confirmation-header--success">
        <span class="confirmation-icon">‚úÖ</span>
        <h3 class="confirmation-title">Request Submitted</h3>
      </div>

      <div class="confirmation-body">
        <p class="confirmation-text">
          Your upgrade request has been submitted successfully!
        </p>

        <div class="ticket-reference">
          <span class="ticket-label">Reference Number</span>
          <span class="ticket-id">{{ ticketId }}</span>
        </div>

        <p class="confirmation-note">
          <span class="note-icon">üìß</span>
          Our support team will review your request and contact you within 24-48 hours.
          You can track this request in your Service Requests.
        </p>
      </div>

      <div class="confirmation-actions confirmation-actions--centered">
        <button
          class="btn-confirm"
          (click)="closeSuccessState()"
          type="button"
        >
          Done
        </button>
      </div>
    </div>
  </div>
</div>
