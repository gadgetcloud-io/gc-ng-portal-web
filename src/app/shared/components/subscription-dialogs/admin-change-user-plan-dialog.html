<!-- Admin Change User Plan Dialog -->
<div class="modal-backdrop" *ngIf="isOpen" @fadeIn (click)="handleBackdropClick($event)">
  <div class="modal-container" @slideUp>
    <!-- Modal Header -->
    <div class="modal-header">
      <h2 class="modal-title">Change User Plan</h2>
      <button
        class="btn-close"
        (click)="handleClose()"
        type="button"
        [disabled]="isChanging"
        aria-label="Close"
      >
        âœ•
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Error Alert -->
      <gc-alert
        *ngIf="changeError"
        variant="error"
        [dismissible]="false"
      >
        {{ changeError }}
      </gc-alert>

      <!-- Load Plans Error -->
      <gc-alert
        *ngIf="loadPlansError"
        variant="error"
        [dismissible]="false"
      >
        {{ loadPlansError }}
      </gc-alert>

      <!-- User Info -->
      <div class="user-info-box">
        <h3 class="section-title">User Information</h3>
        <div class="info-row">
          <span class="info-label">Name:</span>
          <span class="info-value">{{ userName }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email:</span>
          <span class="info-value">{{ userEmail }}</span>
        </div>
        <div class="info-row" *ngIf="currentSubscription">
          <span class="info-label">Current Plan:</span>
          <span class="info-value">
            {{ currentSubscription.planDisplayName }}
            <gc-badge variant="success" size="sm">Active</gc-badge>
          </span>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoadingPlans" class="loading-container">
        <gc-loading-spinner variant="primary" size="md" label="Loading plans..."></gc-loading-spinner>
      </div>

      <!-- Plan Selection -->
      <form *ngIf="!isLoadingPlans && !loadPlansError" class="plan-form" (ngSubmit)="handleSubmit()">
        <!-- Available Plans -->
        <div class="form-section">
          <h3 class="section-title">
            Select New Plan <span class="required">*</span>
          </h3>

          <div class="plans-grid">
            <div
              *ngFor="let plan of plans"
              class="plan-card"
              [class.selected]="isPlanSelected(plan.id)"
              [class.current]="isPlanCurrent(plan.id)"
              (click)="selectedPlanId = plan.id; fieldErrors['selectedPlanId'] = ''"
            >
              <!-- Plan Header -->
              <div class="plan-header">
                <div class="plan-header-content">
                  <h4 class="plan-name">{{ plan.displayName }}</h4>
                  <gc-badge
                    *ngIf="isPlanCurrent(plan.id)"
                    variant="info"
                    size="sm"
                  >
                    Current
                  </gc-badge>
                </div>
                <div class="plan-price">
                  <span class="price-amount">
                    {{ plan.price.amount === 0 ? 'Free' : 'â‚¹' + plan.price.amount }}
                  </span>
                  <span *ngIf="plan.price.amount > 0" class="price-period">
                    / {{ plan.price.billingPeriod }}
                  </span>
                </div>
              </div>

              <!-- Plan Description -->
              <p class="plan-description">{{ plan.description }}</p>

              <!-- Key Features -->
              <div class="plan-features">
                <div class="feature-item">
                  <span class="feature-icon">ðŸ“±</span>
                  <span class="feature-text">
                    {{ plan.features.maxDevices === -1 ? 'Unlimited' : plan.features.maxDevices }} Devices
                  </span>
                </div>
                <div class="feature-item">
                  <span class="feature-icon">ðŸ’¾</span>
                  <span class="feature-text">
                    {{ plan.features.maxStorageBytes === -1 ? 'Unlimited' : (plan.features.maxStorageBytes / 1048576).toFixed(0) + ' MB' }} Storage
                  </span>
                </div>
                <div class="feature-item" *ngIf="plan.features.aiPhotoRecognition">
                  <span class="feature-icon">âœ¨</span>
                  <span class="feature-text">AI Photo Recognition</span>
                </div>
              </div>

              <!-- Selection Radio -->
              <div class="plan-radio">
                <input
                  type="radio"
                  [id]="'plan-' + plan.id"
                  name="selectedPlan"
                  [value]="plan.id"
                  [(ngModel)]="selectedPlanId"
                  [disabled]="isChanging"
                />
                <label [for]="'plan-' + plan.id" class="radio-label">
                  {{ isPlanCurrent(plan.id) ? 'Current Plan' : 'Select This Plan' }}
                </label>
              </div>
            </div>
          </div>

          <small class="form-error" *ngIf="fieldErrors['selectedPlanId']">
            {{ fieldErrors['selectedPlanId'] }}
          </small>
        </div>

        <!-- Reason -->
        <div class="form-section">
          <div class="form-group">
            <label class="form-label" for="change-reason">
              Reason for Change <span class="required">*</span>
            </label>
            <textarea
              id="change-reason"
              class="form-control form-textarea"
              [(ngModel)]="reason"
              name="reason"
              placeholder="Explain why you're changing this user's plan (minimum 10 characters)"
              rows="4"
              [disabled]="isChanging"
              [class.error]="fieldErrors['reason']"
            ></textarea>
            <small class="form-hint">Required for audit trail</small>
            <small class="form-error" *ngIf="fieldErrors['reason']">
              {{ fieldErrors['reason'] }}
            </small>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button
        class="btn-secondary"
        (click)="handleClose()"
        type="button"
        [disabled]="isChanging"
      >
        Cancel
      </button>
      <button
        class="btn-primary"
        (click)="handleSubmit()"
        type="button"
        [disabled]="isChanging || isLoadingPlans"
      >
        <span *ngIf="!isChanging">
          Change Plan
        </span>
        <span *ngIf="isChanging" class="btn-loading">
          <gc-loading-spinner variant="light" size="sm"></gc-loading-spinner>
          <span class="btn-loading-text">Changing...</span>
        </span>
      </button>
    </div>
  </div>
</div>
