<div class="tokens-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>GadgetTokens Wallet</h1>
      <p class="subtitle">Manage your token balance and view transaction history</p>
    </div>
  </div>

  <!-- Alert Messages -->
  <gc-alert
    *ngIf="successMessage"
    variant="success"
    [dismissible]="true"
    (onDismiss)="dismissSuccess()"
  >
    {{ successMessage }}
  </gc-alert>

  <gc-alert
    *ngIf="errorMessage"
    variant="error"
    [dismissible]="true"
    (onDismiss)="dismissError()"
  >
    {{ errorMessage }}
  </gc-alert>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Balance Card -->
    <gc-card variant="elevated" padding="lg" class="balance-card">
      <div class="balance-header">
        <span class="balance-icon">üí∞</span>
        <span class="balance-label">Current Balance</span>
      </div>

      <div class="balance-content" *ngIf="!isLoadingWallet">
        <div class="balance-amount">
          <span class="token-count">{{ wallet?.balance || 0 }}</span>
          <span class="token-label">GadgetTokens</span>
        </div>
        <div class="balance-equivalent" *ngIf="wallet">
          <span class="equivalent-value">{{ formatINR((wallet.balance || 0) * 100) }}</span>
          <span class="equivalent-label">equivalent value</span>
        </div>
      </div>

      <div class="balance-loading" *ngIf="isLoadingWallet">
        <gc-loading-spinner variant="primary" size="md"></gc-loading-spinner>
      </div>

      <div class="balance-actions">
        <gc-button
          variant="primary"
          size="md"
          [fullWidth]="true"
          (click)="togglePurchaseForm()"
        >
          <span *ngIf="!showPurchaseForm">+ Buy More Tokens</span>
          <span *ngIf="showPurchaseForm">Cancel Purchase</span>
        </gc-button>
      </div>

      <!-- Low Balance Warning -->
      <div class="low-balance-warning" *ngIf="wallet && wallet.balance < 5">
        <span class="warning-icon">‚ö†Ô∏è</span>
        <span class="warning-text">Low balance! Buy more tokens to renew your subscription.</span>
      </div>
    </gc-card>

    <!-- Stats Card -->
    <gc-card variant="bordered" padding="md" class="stats-card">
      <h3>Token Statistics</h3>
      <div class="stats-grid" *ngIf="wallet && !isLoadingWallet">
        <div class="stat-item">
          <span class="stat-value">{{ wallet.totalPurchased }}</span>
          <span class="stat-label">Total Purchased</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ wallet.totalSpent }}</span>
          <span class="stat-label">Total Spent</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ wallet.balance }}</span>
          <span class="stat-label">Available</span>
        </div>
      </div>
      <div class="stats-loading" *ngIf="isLoadingWallet">
        <gc-loading-spinner variant="primary" size="sm"></gc-loading-spinner>
      </div>
    </gc-card>

    <!-- Info Card -->
    <gc-card variant="bordered" padding="md" class="info-card">
      <h3>About GadgetTokens</h3>
      <ul class="info-list">
        <li><strong>1 Token = ‚Çπ100</strong> (pre-GST)</li>
        <li>Tokens <strong>never expire</strong></li>
        <li>Use for subscriptions & renewals</li>
        <li>Refundable within 30 days</li>
      </ul>
      <a routerLink="/pricing" class="view-plans-link">View Subscription Plans ‚Üí</a>
    </gc-card>
  </div>

  <!-- Purchase Form (Expandable) -->
  <gc-card variant="elevated" padding="lg" class="purchase-card" *ngIf="showPurchaseForm">
    <h2>Buy GadgetTokens</h2>

    <!-- Preset Amounts -->
    <div class="preset-buttons">
      <button
        class="preset-btn"
        [class.active]="tokenAmount === 5"
        (click)="setPresetAmount(5)"
      >
        5 Tokens
        <span class="preset-price">‚Çπ500</span>
      </button>
      <button
        class="preset-btn"
        [class.active]="tokenAmount === 15"
        (click)="setPresetAmount(15)"
      >
        15 Tokens
        <span class="preset-price">‚Çπ1,500</span>
      </button>
      <button
        class="preset-btn"
        [class.active]="tokenAmount === 30"
        (click)="setPresetAmount(30)"
      >
        30 Tokens
        <span class="preset-price">‚Çπ3,000</span>
      </button>
      <button
        class="preset-btn"
        [class.active]="tokenAmount === 50"
        (click)="setPresetAmount(50)"
      >
        50 Tokens
        <span class="preset-price">‚Çπ5,000</span>
      </button>
    </div>

    <!-- Custom Amount -->
    <div class="custom-amount">
      <label class="input-label">Or enter custom amount:</label>
      <div class="amount-input-wrapper">
        <input
          type="number"
          class="amount-input"
          [min]="minTokens"
          [max]="maxTokens"
          [(ngModel)]="tokenAmount"
          (ngModelChange)="onTokenAmountChange($event)"
        />
        <span class="input-suffix">Tokens</span>
      </div>
      <p class="input-helper">Min: {{ minTokens }}, Max: {{ maxTokens | number }}</p>
    </div>

    <!-- Price Summary -->
    <div class="price-summary">
      <div class="price-row">
        <span>Token Amount</span>
        <span>{{ tokenAmount }} Token{{ tokenAmount !== 1 ? 's' : '' }}</span>
      </div>
      <div class="price-row">
        <span>Price (@ ‚Çπ100/token)</span>
        <span>{{ formatINR(calculateAmounts().inrAmount) }}</span>
      </div>
      <div class="price-row" *ngIf="calculateAmounts().gstAmount > 0">
        <span>GST (18%)</span>
        <span>{{ formatINR(calculateAmounts().gstAmount) }}</span>
      </div>
      <div class="price-row total">
        <span>Total</span>
        <span>{{ formatINR(calculateAmounts().totalAmount) }}</span>
      </div>
    </div>

    <!-- Purchase Button -->
    <div class="purchase-action">
      <gc-button
        variant="primary"
        size="lg"
        [fullWidth]="true"
        [disabled]="isPurchasing"
        (click)="purchaseTokens()"
      >
        <span *ngIf="!isPurchasing">Purchase {{ tokenAmount }} Tokens for {{ formatINR(calculateAmounts().totalAmount) }}</span>
        <span *ngIf="isPurchasing">Processing...</span>
      </gc-button>
    </div>

    <p class="mock-notice">
      <em>Note: This is a mock payment flow. In production, you'll be redirected to Razorpay.</em>
    </p>
  </gc-card>

  <!-- Transaction History -->
  <gc-card variant="bordered" padding="md" class="transactions-card">
    <div class="transactions-header">
      <h2>Transaction History</h2>
      <span class="transaction-count" *ngIf="transactionTotal > 0">
        {{ transactionTotal }} transaction{{ transactionTotal !== 1 ? 's' : '' }}
      </span>
    </div>

    <!-- Loading State -->
    <div class="transactions-loading" *ngIf="isLoadingTransactions">
      <gc-loading-spinner
        variant="primary"
        size="lg"
        label="Loading transactions..."
        [centered]="true"
      ></gc-loading-spinner>
    </div>

    <!-- Empty State -->
    <gc-empty-state
      *ngIf="!isLoadingTransactions && transactions.length === 0"
      variant="no-data"
      icon="üìã"
      title="No transactions yet"
      description="Your token purchases and subscription payments will appear here."
      size="md"
    ></gc-empty-state>

    <!-- Transaction List -->
    <div class="transaction-list" *ngIf="!isLoadingTransactions && transactions.length > 0">
      <div class="transaction-item" *ngFor="let txn of transactions">
        <div class="txn-icon" [class]="getTransactionTypeClass(txn.type)">
          <span *ngIf="getTransactionTypeClass(txn.type) === 'credit'">+</span>
          <span *ngIf="getTransactionTypeClass(txn.type) === 'debit'">-</span>
        </div>
        <div class="txn-info">
          <div class="txn-description">{{ txn.description }}</div>
          <div class="txn-meta">
            <gc-badge [variant]="getTransactionBadgeVariant(txn.type)" size="sm">
              {{ getTransactionTypeLabel(txn.type) }}
            </gc-badge>
            <span class="txn-date">{{ formatDate(txn.createdAt) }}</span>
          </div>
        </div>
        <div class="txn-amount" [class]="getTransactionTypeClass(txn.type)">
          <span *ngIf="txn.amount > 0">+{{ txn.amount }}</span>
          <span *ngIf="txn.amount < 0">{{ txn.amount }}</span>
          <span class="txn-balance">Balance: {{ txn.balanceAfter }}</span>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="transactionTotal > transactionLimit">
      <gc-button
        variant="ghost"
        size="sm"
        [disabled]="!canLoadPrevious"
        (click)="loadPreviousPage()"
      >
        Previous
      </gc-button>
      <span class="page-info">
        {{ transactionOffset + 1 }}-{{ getPageEndIndex() }} of {{ transactionTotal }}
      </span>
      <gc-button
        variant="ghost"
        size="sm"
        [disabled]="!canLoadNext"
        (click)="loadNextPage()"
      >
        Next
      </gc-button>
    </div>
  </gc-card>
</div>
