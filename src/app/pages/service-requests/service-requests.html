<!-- Page Header -->
<section class="page-header">
  <div class="container">
    <div class="header-content">
      <div class="header-text">
        <h1 class="page-title">Manage Tickets</h1>
        <p class="page-subtitle">Track and manage your support tickets</p>
      </div>
      <gc-button variant="primary" size="md" (click)="openNewRequestDialog()">
        â• New Request
      </gc-button>
    </div>
  </div>
</section>

<!-- Filters Section -->
<section class="filters-section">
  <div class="container">
    <!-- Search Bar (Support only) -->
    <div class="search-bar" *ngIf="isSupportRole">
      <input type="text" class="search-input"
        placeholder="Search by ticket ID, customer name/email, or description..."
        [value]="searchTerm" (input)="onSearchChange($event)" />
      <span class="search-icon">ğŸ”</span>
    </div>

    <div class="filter-controls">
      <select class="filter-select" [value]="selectedStatus" (change)="onStatusChange($event)">
        <option *ngFor="let status of statuses" [value]="status.value">
          {{ status.label }}
        </option>
      </select>

      <select class="filter-select" [value]="selectedType" (change)="onTypeChange($event)">
        <option *ngFor="let type of types" [value]="type.value">
          {{ type.label }}
        </option>
      </select>

      <!-- Assignment Filter (Support only) -->
      <select class="filter-select filter-assignment" *ngIf="isSupportRole"
        [value]="selectedAssignment" (change)="onAssignmentChange($event)">
        <option value="all">All Tickets</option>
        <option value="assigned-to-me">Assigned to Me</option>
        <option value="unassigned">Unassigned</option>
      </select>
    </div>

    <div class="results-count">
      <span>{{ filteredRequests.length}} {{ filteredRequests.length === 1 ? 'request' : 'requests' }} found</span>
    </div>
  </div>
</section>

<!-- Service Requests Section -->
<section class="requests-section">
  <div class="container">
    <!-- Redirecting State -->
    <div *ngIf="isRedirecting" class="loading-state">
      <div class="spinner"></div>
      <p>Redirecting to ticket details...</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading && !isRedirecting" class="loading-state">
      <div class="spinner"></div>
      <p>Loading tickets...</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && !isRedirecting && filteredRequests.length === 0 && serviceRequests.length === 0" class="empty-state">
      <div class="empty-icon">ğŸ“‹</div>
      <h2 class="empty-title">No tickets yet</h2>
      <p class="empty-text">Create your first ticket to get support for your gadgets</p>
      <gc-button variant="primary" size="lg" (click)="openNewRequestDialog()">
        â• Create Ticket
      </gc-button>
    </div>

    <!-- No Results State -->
    <div *ngIf="!isLoading && !isRedirecting && filteredRequests.length === 0 && serviceRequests.length > 0" class="empty-state">
      <div class="empty-icon">ğŸ”</div>
      <h2 class="empty-title">No tickets match your filters</h2>
      <p class="empty-text">Try adjusting your filters</p>
    </div>

    <!-- Requests List -->
    <div *ngIf="!isLoading && !isRedirecting && filteredRequests.length > 0" class="requests-list">
      <div
        *ngFor="let ticket of filteredRequests"
        [id]="'ticket-' + ticket.id"
        class="request-card"
        (click)="viewRequestDetails(ticket)"
      >
        <div class="request-header">
          <div class="request-type">
            <span class="type-icon">{{ getTypeIcon(ticket.data.requestType) }}</span>
            <span class="type-label">{{ getTypeLabel(ticket.data.requestType) }}</span>
          </div>
          <div class="request-badges">
            <span class="badge priority-badge" [class]="getPriorityColor(ticket.priority)">
              {{ getPriorityLabel(ticket.priority) }}
            </span>
            <span class="badge status-badge" [class]="getStatusColor(ticket.status)">
              {{ getStatusLabel(ticket.status) }}
            </span>
          </div>
        </div>

        <div class="request-content">
          <div class="request-id">#{{ ticket.id }}</div>
          <h3 class="request-subject">{{ ticket.data.additionalNotes || 'Service Request' }}</h3>
          <p class="request-description">{{ ticket.data.issueDescription }}</p>

          <!-- Customer Info (Support only) -->
          <div class="request-customer-info" *ngIf="isSupportRole && ticket.customer">
            <div class="info-row">
              <span class="info-icon">ğŸ‘¤</span>
              <span class="info-label">Customer:</span>
              <span class="info-value">{{ ticket.customer.name }} ({{ ticket.customer.email }})</span>
            </div>
            <div class="info-row" *ngIf="ticket.customer.mobile">
              <span class="info-icon">ğŸ“</span>
              <span class="info-label">Mobile:</span>
              <span class="info-value">{{ ticket.customer.mobile }}</span>
            </div>
          </div>

          <!-- Enhanced Device Info -->
          <div class="request-device" *ngIf="ticket.device">
            <span class="device-icon">ğŸ“±</span>
            <span>{{ ticket.device.brand }} {{ ticket.device.name }} ({{ ticket.device.category }})</span>
          </div>
          <div class="request-device" *ngIf="!ticket.device && ticket.data.deviceId">
            <span class="device-icon">ğŸ“±</span>
            <span>Device ID: {{ ticket.data.deviceId }}</span>
          </div>
        </div>

        <div class="request-footer">
          <div class="request-dates">
            <div class="date-item">
              <span class="date-label">Created:</span>
              <span class="date-value">{{ formatDate(ticket.createdAt) }}</span>
            </div>
            <div class="date-item">
              <span class="date-label">Updated:</span>
              <span class="date-value">{{ formatDate(ticket.updatedAt) }}</span>
            </div>
          </div>

          <!-- Assignment Controls (Support only) -->
          <div class="assignment-container" *ngIf="isSupportRole">
            <!-- Current assignment display button -->
            <button class="assignment-button"
              [class.assigned]="ticket.assignedTo"
              (click)="toggleAssignmentDropdown(ticket.id, $event)">
              <span class="assigned-icon">ğŸ‘¤</span>
              <span>{{ getAssignedStaffName(ticket.assignedTo) }}</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>

            <!-- Quick "Assign to Me" button -->
            <button class="assign-to-me-btn"
              *ngIf="!ticket.assignedTo || ticket.assignedTo !== user?.id"
              (click)="assignToMe(ticket, $event)"
              [disabled]="assigningTicket[ticket.id]">
              âœ‹ Assign to Me
            </button>

            <!-- Assignment dropdown -->
            <div class="assignment-dropdown" *ngIf="assignmentDropdownOpen[ticket.id]">
              <div class="dropdown-header">Assign to:</div>
              <button *ngFor="let staff of supportStaff"
                class="dropdown-item"
                (click)="assignToStaff(ticket, staff.id, $event)"
                [disabled]="assigningTicket[ticket.id]">
                <span class="staff-name">{{ staff.name }}</span>
                <span class="staff-email">{{ staff.email }}</span>
              </button>
              <button class="dropdown-item unassign-item" *ngIf="ticket.assignedTo"
                (click)="unassignTicket(ticket, $event)"
                [disabled]="assigningTicket[ticket.id]">
                ğŸš« Unassign
              </button>
            </div>
          </div>

          <!-- Customer view: Simple assigned display -->
          <div class="request-assigned" *ngIf="!isSupportRole && ticket.assignedTo">
            <span class="assigned-icon">ğŸ‘¤</span>
            <span>{{ ticket.assignedTo }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
